<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  height:100vh;
  color:white;
}
.main{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.lobby{
  background:white;
  color:black;
  padding:40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}
.btn{
  display:block;
  width:200px;
  margin:15px auto;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}
.solo{background:#4CAF50;color:white;}
.multi{background:#ff9800;color:white;}
.sidebar{
  width:330px;
  background:rgba(0,0,0,0.35);
  padding:20px;
  overflow-y:auto;
}
.friend{
  background:white;
  color:black;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
}
button{
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-top:5px;
}
.add-btn{background:#4CAF50;color:white;}
input{
  width:100%;
  padding:5px;
  margin-top:5px;
}
.status{
  font-size:12px;
  color:gray;
}

.invite-btn{background:#4CAF50;color:white;}
.delete-btn{background:#f44336;color:white;}

.party-box{
  background:#222;
  color:white;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}

.party-member{
  background:#333;
  padding:5px;
  margin-top:5px;
  border-radius:6px;
}

</style>
</head>

<body>

<div class="main">
  <div class="lobby">
    <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</h1>
    <button class="btn solo">ä¸€äººã§ãƒ—ãƒ¬ã‚¤</button>
    <button class="btn multi">ã¿ã‚“ãªã§ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>

<div class="sidebar">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div id="profileArea"></div>
  <div id="partyArea"></div>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </h2>
  <input id="friendCodeInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰8æ¡">
  <button class="add-btn" onclick="requestFriend()">ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</button>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h2>
  <div id="friendList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, collection,
  onSnapshot, deleteDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getDatabase, ref, set, onValue, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ---------- Firebase è¨­å®š (ãã®ã¾ã¾ä½¿ã£ã¦OK) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBXnNXQ5khcR0EvRide4C0PjshJZpSF4oM",
  authDomain: "typing-game-28ed0.firebaseapp.com",
  projectId: "typing-game-28ed0",
  databaseURL: "https://typing-game-28ed0-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rtdb = getDatabase(app);

/* ---------- åˆæœŸ ---------- */
function rand(l){ let s=""; for(let i=0;i<l;i++){ s += Math.floor(Math.random()*10); } return s; }
if(!localStorage.playerName) localStorage.playerName = "åœ’å:" + rand(12);
if(!localStorage.friendCode) localStorage.friendCode = rand(8);

const myCode = localStorage.friendCode;
let myName = localStorage.playerName;

/* ---------- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç®¡ç† (heartbeat) ---------- */
const statusRef = ref(rtdb, "status/" + myCode);
async function writeOnline(online=true){
  try{
    await set(statusRef, { online: !!online, name: myName, lastSeen: Date.now() });
  }catch(e){ console.warn("status write error", e); }
}
writeOnline(true);
onDisconnect(statusRef).set({ online: false, name: myName, lastSeen: Date.now() });
const HEART_MS = 5000;
const hb = setInterval(()=> writeOnline(true), HEART_MS);

/* ---------- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« UI ---------- */
function renderProfile(){
  document.getElementById("profileArea").innerHTML = `
    åå‰:<br>
    <input id="nameInput" value="${myName}">
    <button id="changeNameBtn" style="padding:6px 8px;margin-left:6px;">å¤‰æ›´</button>
    <hr>
    ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰:<br>
    <strong>${myCode}</strong>
  `;
  document.getElementById("changeNameBtn").onclick = async () => {
    myName = document.getElementById("nameInput").value || myName;
    localStorage.playerName = myName;
    await setDoc(doc(db,"users",myCode), { name: myName }, { merge: true });
    writeOnline(true);
  };
}
renderProfile();
await setDoc(doc(db,"users",myCode), { name: myName }, { merge: true });

/* ---------- ãƒ•ãƒ¬ãƒ³ãƒ‰æ“ä½œ ---------- */
window.requestFriend = async function(){
  const code = document.getElementById("friendCodeInput").value.trim();
  if(code.length !== 8) return alert("8æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(code === myCode) return alert("è‡ªåˆ†ã¯è¿½åŠ ã§ãã¾ã›ã‚“");
  const snap = await getDoc(doc(db,"users",code));
  if(!snap.exists()) return alert("ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å­˜åœ¨ã—ã¾ã›ã‚“");
  await setDoc(doc(db,"users",myCode,"friends",code), { name: snap.data().name });
  await setDoc(doc(db,"users",code,"friends",myCode), { name: myName });
  alert("ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ ã—ã¾ã—ãŸ");
};

window.removeFriend = async function(code){
  if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await deleteDoc(doc(db,"users",myCode,"friends",code));
  await deleteDoc(doc(db,"users",code,"friends",myCode));
};

/* ---------- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆè¡¨ç¤º + å®‰å®šã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ¤å®š ---------- */
let friendListeners = {}; // code -> unsubscribe function

onSnapshot(collection(db,"users",myCode,"friends"), (snap) => {
  const list = document.getElementById("friendList");
  list.innerHTML = "";

  // æ—¢å­˜ listeners ã‚’è§£é™¤
  for(const k in friendListeners){
    try { friendListeners[k](); } catch(e){}
  }
  friendListeners = {};

  snap.forEach(docSnap => {
    const fcode = docSnap.id;
    const fname = docSnap.data().name || ("åœ’å:" + rand(12));

    const div = document.createElement("div");
    div.className = "friend";
    div.innerHTML = `
      <strong id="f-name-${fcode}">${fname}</strong><br>
      Code: ${fcode}<br>
      <span id="status-${fcode}">ç¢ºèªä¸­...</span><br>
      <button id="inviteBtn-${fcode}" style="background:#4CAF50;color:white;padding:6px;border-radius:8px;border:none;margin-right:6px;">æ‹›å¾…</button>
      <button id="delBtn-${fcode}" style="background:#f44336;color:white;padding:6px;border-radius:8px;border:none;">å‰Šé™¤</button>
    `;
    list.appendChild(div);

    // ãƒœã‚¿ãƒ³å‹•ä½œã‚’ã‚»ãƒƒãƒˆ
    document.getElementById(`inviteBtn-${fcode}`).onclick = ()=> inviteParty(fcode);
    document.getElementById(`delBtn-${fcode}`).onclick = ()=> removeFriend(fcode);

    // RTDB status ã‚’ç›£è¦–ã™ã‚‹ï¼ˆåˆæœŸã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼‰
    const r = ref(rtdb, "status/" + fcode);
    const unsub = onValue(r, (s) => {
      const el = document.getElementById("status-" + fcode);
      const nameEl = document.getElementById("f-name-" + fcode);
      if(!el) return;
      if(s.exists()){
        const data = s.val();
        // 15ç§’ä»¥å†…ã« lastSeen æ›´æ–°ãŒã‚ã‚Œã°ã‚ªãƒ³ãƒ©ã‚¤ãƒ³åˆ¤å®š
        const last = data.lastSeen || 0;
        const now = Date.now();
        if(data.online && (now - last) < 15000){
          el.innerHTML = "<span style='color:green'>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>";
        } else {
          el.innerHTML = "<span style='color:red'>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>";
        }
        // åå‰åŒæœŸï¼ˆã‚‚ã—RTDBå´ã§åå‰ã‚’æ›´æ–°ã—ã¦ã„ã‚‹ãªã‚‰åæ˜ ï¼‰
        if(data.name && nameEl) nameEl.textContent = data.name;
      } else {
        el.innerHTML = "<span style='color:red'>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>";
      }
    }, { onlyOnce: false });

    friendListeners[fcode] = unsub;
  });
});

/* ---------- æ‹›å¾…ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆå·¦ä¸Šãƒ»å¤§ãã‚ï¼‰ ---------- */
function ensureInviteContainer(){
  let c = document.getElementById("inviteToastContainer");
  if(c) return c;
  c = document.createElement("div");
  c.id = "inviteToastContainer";
  c.style.position = "fixed";
  c.style.top = "12px";
  c.style.left = "12px";
  c.style.zIndex = 99999;
  document.body.appendChild(c);
  return c;
}

const inviteElems = new Map(); // inviteId -> element

function showInviteToast(inviteId, fromCode, fromName){
  const container = ensureInviteContainer();
  if(inviteElems.has(inviteId)) return; // é‡è¤‡é˜²æ­¢
  const box = document.createElement("div");
  box.style.background = "#fff";
  box.style.color = "#000";
  box.style.padding = "14px";
  box.style.borderRadius = "12px";
  box.style.boxShadow = "0 8px 24px rgba(0,0,0,0.25)";
  box.style.marginBottom = "8px";
  box.style.minWidth = "280px";
  box.innerHTML = `
    <div style="font-weight:700;margin-bottom:8px">${fromName} ã‹ã‚‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼æ‹›å¾…</div>
    <div style="display:flex;gap:8px">
      <button id="accept-${inviteId}" style="background:#4CAF50;color:white;padding:8px;border-radius:8px;border:none;flex:1">å‚åŠ </button>
      <button id="reject-${inviteId}" style="background:#f44336;color:white;padding:8px;border-radius:8px;border:none;flex:1">æ‹’å¦</button>
    </div>
  `;
  container.appendChild(box);
  inviteElems.set(inviteId, box);

  document.getElementById(`accept-${inviteId}`).onclick = async () => {
    try{
      await joinParty(fromCode);
    }catch(e){
      console.error(e);
      alert("å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
    // æ‹›å¾…å‰Šé™¤
    await deleteDoc(doc(db,"users",myCode,"invites",inviteId));
    // å‰Šé™¤ UI
    const el = inviteElems.get(inviteId);
    if(el) el.remove();
    inviteElems.delete(inviteId);
  };

  document.getElementById(`reject-${inviteId}`).onclick = async () => {
    await deleteDoc(doc(db,"users",myCode,"invites",inviteId));
    const el = inviteElems.get(inviteId);
    if(el) el.remove();
    inviteElems.delete(inviteId);
  };
}

/* ---------- æ‹›å¾…é€ä¿¡ ---------- */
window.inviteParty = async function(target){
  if(target === myCode) return alert("è‡ªåˆ†ã«ã¯é€ã‚Œã¾ã›ã‚“");
  // å—ã‘å–ã‚Šå´ users/{target}/invites/{fromCode}
  await setDoc(doc(db,"users",target,"invites",myCode), {
    from: myCode,
    fromName: myName,
    created: Date.now()
  });
  alert("æ‹›å¾…ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
};

/* æ‹›å¾…å—ä¿¡ã®ç›£è¦– */
onSnapshot(collection(db,"users",myCode,"invites"), (snapshot) => {
  snapshot.docChanges().forEach(change => {
    if(change.type === "added"){
      const id = change.doc.id; // é€ä¿¡å…ƒã‚³ãƒ¼ãƒ‰ã‚’ id ã«ã—ã¦ã„ã‚‹
      const d = change.doc.data();
      showInviteToast(id, d.from, d.fromName || "ä¸æ˜");
    }
  });
});

/* ---------- ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼å‚åŠ ãƒ­ã‚¸ãƒƒã‚¯ ---------- */
async function ensureLeaderInParty(leaderCode){
  // leader ã® users/ ãƒªã‚¢ãƒ«åå–å¾—
  const leaderUserSnap = await getDoc(doc(db,"users",leaderCode));
  const leaderName = (leaderUserSnap.exists() && leaderUserSnap.data().name) ? leaderUserSnap.data().name : "ãƒªãƒ¼ãƒ€ãƒ¼";
  // ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆï¼ˆmergeï¼‰
  await setDoc(doc(db,"parties",leaderCode), { leader: leaderCode, leaderName: leaderName }, { merge: true });
  // leader ã‚’ members ã«å…¥ã‚Œã‚‹ï¼ˆrole: leaderï¼‰
  await setDoc(doc(db,"parties",leaderCode,"members", leaderCode), { name: leaderName, role: "leader" }, { merge: true });
}

// joinParty: æ‹›å¾…å—ã‘ãŸå´ãŒå‚åŠ ï¼ˆinvitedï¼‰ã€‚æ‹›å¾…è€…ã¯ãƒªãƒ¼ãƒ€ãƒ¼ã«ãªã‚‹ï¼ˆãªã£ã¦ãªã‘ã‚Œã°ç™»éŒ²ï¼‰ã€‚
async function joinParty(leaderCode){
  // ã¾ãš leader ã‚’ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã«ç¢ºå®Ÿã«å…¥ã‚Œã‚‹ï¼ˆä½œã‚‹å´ï¼‰
  await ensureLeaderInParty(leaderCode);

  // è‡ªåˆ†ã‚’ members ã«è¿½åŠ ï¼ˆrole: memberï¼‰
  await setDoc(doc(db,"parties",leaderCode,"members", myCode), { name: myName, role: "member" }, { merge: true });
}

/* ---------- ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ UI ç›£è¦–ï¼ˆå®‰å®šï¼‰ ---------- */
onSnapshot(collection(db,"parties"), async (snapshot) => {
  const partyArea = document.getElementById("partyArea");
  if(!partyArea) return;
  partyArea.innerHTML = "";

  for(const partyDoc of snapshot.docs){
    const leader = partyDoc.id;
    const partyMeta = partyDoc.data();
    const membersSnap = await getDocs(collection(db,"parties",leader,"members"));

    // è‡ªåˆ†ãŒãã®ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã®ãƒ¡ãƒ³ãƒãƒ¼ã‹ã©ã†ã‹
    const amMember = membersSnap.docs.some(d => d.id === myCode);
    if(!amMember) continue;

    // build UI
    const box = document.createElement("div");
    box.className = "party-box";
    box.innerHTML = `<h3>ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼</h3>`;
    box.innerHTML += `<div>ãƒªãƒ¼ãƒ€ãƒ¼: ${partyMeta.leaderName || leader} ${leader === myCode ? "ğŸ‘‘" : ""}</div>`;
    box.innerHTML += `<div>äººæ•°: ${membersSnap.size}</div>`;

    // members list
    membersSnap.forEach(mem => {
      const memData = mem.data();
      const role = memData.role || "member";
      const crown = (mem.id === leader) ? " ğŸ‘‘" : "";
      // show name and action if leader
      let memberLine = `<div class="party-member" id="pm-${leader}-${mem.id}"> ${memData.name || "åç„¡ã—"}${crown} `;
      if(leader === myCode && mem.id !== myCode){
        // leader can kick
        memberLine += `<button style="background:#f44336;color:white;margin-left:8px;" onclick="kick('${leader}','${mem.id}')">ã‚­ãƒƒã‚¯</button>`;
      }
      memberLine += `</div>`;
      box.innerHTML += memberLine;
    });

    // actions: leader = disband, members = leave; (è¦æœ›ã©ãŠã‚Šãƒ¡ãƒ³ãƒãƒ¼ã‚‚è§£æ•£å¯èƒ½ã«ã™ã‚‹å ´åˆã¯è¡¨ç¤º)
    if(leader === myCode){
      box.innerHTML += `<div style="margin-top:8px;"><button style="background:#f44336;color:white;padding:8px;border-radius:6px;border:none;" onclick="disband('${leader}')">è§£æ•£</button></div>`;
    } else {
      box.innerHTML += `<div style="margin-top:8px;"><button style="background:#ff9800;color:white;padding:8px;border-radius:6px;border:none;" onclick="leave('${leader}')">é›¢è„±</button></div>`;
      // ã‚‚ã—ãƒ¡ãƒ³ãƒãƒ¼ã«ã‚‚è§£æ•£æ¨©ã‚’å‡ºã—ãŸã‘ã‚Œã°ã“ã¡ã‚‰ã«è§£æ•£ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆä»Šã¯é›¢è„±ã®ã¿ï¼‰
    }

    partyArea.appendChild(box);
  }
});

/* ---------- æ“ä½œ: kick / leave / disband ---------- */
window.kick = async function(leader, member){
  if(!confirm("æœ¬å½“ã«ã‚­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await deleteDoc(doc(db,"parties",leader,"members",member));
};

window.leave = async function(leader){
  await deleteDoc(doc(db,"parties",leader,"members",myCode));
};

window.disband = async function(leader){
  if(!confirm("æœ¬å½“ã«ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã‚’è§£æ•£ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const membersSnap = await getDocs(collection(db,"parties",leader,"members"));
  for(const m of membersSnap.docs){
    await deleteDoc(doc(db,"parties",leader,"members",m.id));
  }
  await deleteDoc(doc(db,"parties",leader));
};

/* ---------- çµ‚äº†/unload ã®å¾Œç‰‡ä»˜ã‘ ---------- */
window.addEventListener("beforeunload", async () => {
  try{
    await set(statusRef, { online: false, name: myName, lastSeen: Date.now() });
  }catch(e){}
  clearInterval(hb);
});
</script>

</body>
</html>
