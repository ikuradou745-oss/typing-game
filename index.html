<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</title>

<style>

<!-- Firebaseè¿½åŠ  -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXnNXQ5khcR0EvRide4C0PjshJZpSF4oM",
  authDomain: "typing-game-28ed0.firebaseapp.com",
  projectId: "typing-game-28ed0",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const myCode = localStorage.friendCode;
const myName = localStorage.playerName;

/* Firestoreã«è‡ªåˆ†ã‚’ç™»éŒ² */
await setDoc(doc(db,"users",myCode),{
  name: myName
},{merge:true});

/* ğŸ”¥ æ—¢å­˜ã®requestFriendã‚’ä¸Šæ›¸ã */
window.requestFriend = async function(){
  const code=document.getElementById("friendCodeInput").value;
  if(code.length!==8) return alert("8æ¡å…¥åŠ›ï¼");

  const targetRef = doc(db,"users",code);
  const targetSnap = await getDoc(targetRef);

  if(!targetSnap.exists()){
    return alert("ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“");
  }

  // è‡ªåˆ†å´
  await setDoc(doc(db,"users",myCode,"friends",code),{
    name: targetSnap.data().name
  });

  // ç›¸æ‰‹å´ï¼ˆä¸¡æ–¹å‘ï¼‰
  await setDoc(doc(db,"users",code,"friends",myCode),{
    name: myName
  });
};

/* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º */
onSnapshot(collection(db,"users",myCode,"friends"),(snapshot)=>{
  const list=document.getElementById("friendList");
  list.innerHTML="";
  snapshot.forEach(docSnap=>{
    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${docSnap.data().name}</strong><br>
      Code:${docSnap.id}<br>
      <span class="status">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é€£æºä¸­</span>
    `;
    list.appendChild(div);
  });
});
</script>

  
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  height:100vh;
  color:white;
}

/* å·¦ï¼šãƒ­ãƒ“ãƒ¼ */
.main{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}

.lobby{
  background:white;
  color:black;
  padding:40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}

.btn{
  display:block;
  width:200px;
  margin:15px auto;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}

.solo{background:#4CAF50;color:white;}
.multi{background:#ff9800;color:white;}

/* å³ï¼šãƒ•ãƒ¬ãƒ³ãƒ‰ */
.sidebar{
  width:330px;
  background:rgba(0,0,0,0.35);
  padding:20px;
  overflow-y:auto;
}

.friend{
  background:white;
  color:black;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
}

button{
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-top:5px;
}

.add-btn{background:#4CAF50;color:white;}
.remove-btn{background:#f44336;color:white;}

input{
  width:100%;
  padding:5px;
  margin-top:5px;
}
.status{
  font-size:12px;
  color:gray;
}
</style>
</head>

<body>

<!-- å·¦ãƒ­ãƒ“ãƒ¼ -->
<div class="main">
  <div class="lobby">
    <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</h1>

    <button class="btn solo">ä¸€äººã§ãƒ—ãƒ¬ã‚¤</button>
    <button class="btn multi">ã¿ã‚“ãªã§ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>

<!-- å³ãƒ•ãƒ¬ãƒ³ãƒ‰ -->
<div class="sidebar">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div id="profileArea"></div>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </h2>
  <input id="friendCodeInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰8æ¡">
  <button class="add-btn" onclick="requestFriend()">ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</button>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h2>
  <div id="friendList"></div>
</div>

<script>
function randomNumber(length){
  let r="";
  for(let i=0;i<length;i++){
    r+=Math.floor(Math.random()*10);
  }
  return r;
}

/* åˆæœŸãƒ‡ãƒ¼ã‚¿ */
if(!localStorage.playerName){
  localStorage.playerName="åœ’å:"+randomNumber(12);
}
if(!localStorage.friendCode){
  localStorage.friendCode=randomNumber(8);
}
if(!localStorage.friends){
  localStorage.friends=JSON.stringify([]);
}

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º */
function renderProfile(){
  document.getElementById("profileArea").innerHTML=`
    åå‰:<br>
    <input id="nameInput" value="${localStorage.playerName}">
    <button onclick="changeName()">å¤‰æ›´</button>
    <hr>
    ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰:<br>
    <strong>${localStorage.friendCode}</strong>
  `;
}

function changeName(){
  const newName=document.getElementById("nameInput").value;
  localStorage.playerName=newName;
  renderProfile();
}

/* ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ï¼ˆç–‘ä¼¼ä¸¡æˆç«‹æ–¹å¼ï¼‰ */
function requestFriend(){
  const code=document.getElementById("friendCodeInput").value;
  if(code.length!==8) return alert("8æ¡å…¥åŠ›ï¼");

  let friends=JSON.parse(localStorage.friends);

  // æ—¢ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if(friends.some(f=>f.code===code)){
    return alert("ã™ã§ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ï¼");
  }

  friends.push({
    name:"åœ’å:"+randomNumber(12),
    code:code,
    status:"ãƒ•ãƒ¬ãƒ³ãƒ‰æˆç«‹"
  });

  localStorage.friends=JSON.stringify(friends);
  renderFriends();
}

/* å‰Šé™¤ */
function removeFriend(i){
  let friends=JSON.parse(localStorage.friends);
  friends.splice(i,1);
  localStorage.friends=JSON.stringify(friends);
  renderFriends();
}

function renderFriends(){
  const list=document.getElementById("friendList");
  list.innerHTML="";
  let friends=JSON.parse(localStorage.friends);

  friends.forEach((f,i)=>{
    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${f.name}</strong><br>
      Code:${f.code}<br>
      <span class="status">${f.status}</span><br>
      <button class="remove-btn" onclick="removeFriend(${i})">ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’åˆ‡ã‚‹</button>
    `;
    list.appendChild(div);
  });
}

renderProfile();
renderFriends();
</script>

</body>
</html>
