<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  height:100vh;
  color:white;
}
.main{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.lobby{
  background:white;
  color:black;
  padding:40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}
.btn{
  display:block;
  width:200px;
  margin:15px auto;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}
.solo{background:#4CAF50;color:white;}
.multi{background:#ff9800;color:white;}
.sidebar{
  width:330px;
  background:rgba(0,0,0,0.35);
  padding:20px;
  overflow-y:auto;
}
.friend{
  background:white;
  color:black;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
}
button{
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-top:5px;
}
.add-btn{background:#4CAF50;color:white;}
input{
  width:100%;
  padding:5px;
  margin-top:5px;
}
.status{
  font-size:12px;
  color:gray;
}

.invite-btn{background:#4CAF50;color:white;}
.delete-btn{background:#f44336;color:white;}

.party-box{
  background:#222;
  color:white;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}

.party-member{
  background:#333;
  padding:5px;
  margin-top:5px;
  border-radius:6px;
}

</style>
</head>

<body>

<div class="main">
  <div class="lobby">
    <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</h1>
    <button class="btn solo">ä¸€äººã§ãƒ—ãƒ¬ã‚¤</button>
    <button class="btn multi">ã¿ã‚“ãªã§ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>

<div class="sidebar">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div id="profileArea"></div>
  <div id="partyArea"></div>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </h2>
  <input id="friendCodeInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰8æ¡">
  <button class="add-btn" onclick="requestFriend()">ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</button>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h2>
  <div id="friendList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, collection,
  onSnapshot, deleteDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getDatabase, ref, set, onValue, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBXnNXQ5khcR0EvRide4C0PjshJZpSF4oM",
  authDomain: "typing-game-28ed0.firebaseapp.com",
  projectId: "typing-game-28ed0",
  databaseURL: "https://typing-game-28ed0-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rtdb = getDatabase(app);

/* ========= åˆæœŸè¨­å®š ========= */
function rand(l){ let s=""; for(let i=0;i<l;i++){ s+=Math.floor(Math.random()*10);} return s; }

if(!localStorage.playerName) localStorage.playerName="åœ’å:"+rand(12);
if(!localStorage.friendCode) localStorage.friendCode=rand(8);

const myCode=localStorage.friendCode;
let myName=localStorage.playerName;

/* ========= ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç®¡ç† ========= */
const statusRef=ref(rtdb,"status/"+myCode);

async function setOnline(){
  await set(statusRef,{online:true,name:myName,lastSeen:Date.now()});
}
setOnline();
onDisconnect(statusRef).set({online:false,name:myName,lastSeen:Date.now()});
setInterval(setOnline,5000);

/* ========= ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ========= */
await setDoc(doc(db,"users",myCode),{name:myName},{merge:true});

/* ========= ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ  ========= */
window.requestFriend=async()=>{
  const code=document.getElementById("friendCodeInput").value.trim();
  if(code.length!==8)return alert("8æ¡ã§å…¥åŠ›");
  if(code===myCode)return alert("è‡ªåˆ†ã¯è¿½åŠ ä¸å¯");

  const snap=await getDoc(doc(db,"users",code));
  if(!snap.exists())return alert("å­˜åœ¨ã—ã¾ã›ã‚“");

  await setDoc(doc(db,"users",myCode,"friends",code),{name:snap.data().name});
  await setDoc(doc(db,"users",code,"friends",myCode),{name:myName});
  alert("è¿½åŠ å®Œäº†");
};

window.removeFriend=async(code)=>{
  await deleteDoc(doc(db,"users",myCode,"friends",code));
  await deleteDoc(doc(db,"users",code,"friends",myCode));
};

/* ========= ãƒ•ãƒ¬ãƒ³ãƒ‰è¡¨ç¤º + ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ ========= */
onSnapshot(collection(db,"users",myCode,"friends"),snap=>{
  const list=document.getElementById("friendList");
  list.innerHTML="";

  snap.forEach(docSnap=>{
    const fcode=docSnap.id;
    const fname=docSnap.data().name;

    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${fname}</strong><br>
      Code:${fcode}<br>
      <span id="status-${fcode}">ç¢ºèªä¸­...</span><br>
      <button onclick="inviteParty('${fcode}')" style="background:#4CAF50;color:white;padding:6px;border:none;border-radius:6px;">æ‹›å¾…</button>
      <button onclick="removeFriend('${fcode}')" style="background:#f44336;color:white;padding:6px;border:none;border-radius:6px;">å‰Šé™¤</button>
    `;
    list.appendChild(div);

    const r=ref(rtdb,"status/"+fcode);
    onValue(r,s=>{
      const el=document.getElementById("status-"+fcode);
      if(!s.exists()){el.innerHTML="<span style='color:red'>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>";return;}
      const d=s.val();
      if(d.online && Date.now()-d.lastSeen<15000){
        el.innerHTML="<span style='color:green'>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>";
      }else{
        el.innerHTML="<span style='color:red'>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>";
      }
    });
  });
});

/* ========= æ‹›å¾…é€ä¿¡ ========= */
window.inviteParty=async(target)=>{
  await setDoc(doc(db,"users",target,"invites",myCode),{
    from:myCode,
    fromName:myName,
    created:Date.now()
  });
  alert("æ‹›å¾…é€ä¿¡");
};

/* ========= æ‹›å¾…å—ä¿¡ ========= */
onSnapshot(collection(db,"users",myCode,"invites"),snap=>{
  snap.docChanges().forEach(change=>{
    if(change.type==="added"){
      const d=change.doc.data();
      showInvite(change.doc.id,d.fromName);
    }
  });
});

function showInvite(inviteId,name){
  const box=document.createElement("div");
  box.style.position="fixed";
  box.style.left="20px";
  box.style.top="20px";
  box.style.background="white";
  box.style.padding="15px";
  box.style.borderRadius="12px";
  box.style.boxShadow="0 10px 25px rgba(0,0,0,0.3)";
  box.innerHTML=`
    <b>${name} ã‹ã‚‰æ‹›å¾…</b><br><br>
    <button style="background:#4CAF50;color:white;padding:8px;border:none;border-radius:6px;"
    onclick="acceptInvite('${inviteId}')">å‚åŠ </button>
    <button style="background:#f44336;color:white;padding:8px;border:none;border-radius:6px;"
    onclick="rejectInvite('${inviteId}')">æ‹’å¦</button>
  `;
  document.body.appendChild(box);
}

/* ========= æ‹›å¾…å‡¦ç† ========= */
window.acceptInvite=async(leader)=>{
  await ensureParty(leader);
  await setDoc(doc(db,"parties",leader,"members",myCode),{
    name:myName,
    role:"member"
  });
  await deleteDoc(doc(db,"users",myCode,"invites",leader));
};

window.rejectInvite=async(id)=>{
  await deleteDoc(doc(db,"users",myCode,"invites",id));
};

async function ensureParty(leader){
  const leaderSnap=await getDoc(doc(db,"users",leader));
  const lname=leaderSnap.exists()?leaderSnap.data().name:"Leader";

  await setDoc(doc(db,"parties",leader),{
    leader:leader,
    leaderName:lname
  },{merge:true});

  await setDoc(doc(db,"parties",leader,"members",leader),{
    name:lname,
    role:"leader"
  },{merge:true});
}

/* ========= ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦– ========= */

let currentUnsub=null;

onSnapshot(collection(db,"parties"),snapshot=>{
  let found=null;

  snapshot.forEach(docSnap=>{
    const leader=docSnap.id;
    const memRef=doc(db,"parties",leader,"members",myCode);
    onSnapshot(memRef,s=>{
      if(s.exists()){
        found=leader;
        subscribeParty(leader);
      }
    });
  });

  if(!found){
    document.getElementById("partyArea").innerHTML="";
  }
});

function subscribeParty(leader){
  if(currentUnsub)currentUnsub();

  currentUnsub=onSnapshot(collection(db,"parties",leader,"members"),snap=>{
    const area=document.getElementById("partyArea");
    area.innerHTML="";

    const box=document.createElement("div");
    box.className="party-box";
    box.innerHTML=`<h3>ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼</h3>
    <div>äººæ•°:${snap.size}</div><br>`;

    snap.forEach(m=>{
      const d=m.data();
      const crown=m.id===leader?" ğŸ‘‘":"";
      box.innerHTML+=`<div>
        ${d.name}${crown}
        ${leader===myCode && m.id!==myCode?
          `<button onclick="kick('${leader}','${m.id}')" style="background:#f44336;color:white;margin-left:8px;">ã‚­ãƒƒã‚¯</button>`:""}
      </div>`;
    });

    if(leader===myCode){
      box.innerHTML+=`<br>
      <button onclick="disband('${leader}')" style="background:#f44336;color:white;padding:8px;border:none;border-radius:6px;">è§£æ•£</button>`;
    }else{
      box.innerHTML+=`<br>
      <button onclick="leave('${leader}')" style="background:#ff9800;color:white;padding:8px;border:none;border-radius:6px;">é›¢è„±</button>`;
    }

    area.appendChild(box);
  });
}

/* ========= æ“ä½œ ========= */
window.kick=async(leader,member)=>{
  await deleteDoc(doc(db,"parties",leader,"members",member));
};

window.leave=async(leader)=>{
  await deleteDoc(doc(db,"parties",leader,"members",myCode));
};

window.disband=async(leader)=>{
  const snap=await getDocs(collection(db,"parties",leader,"members"));
  for(const m of snap.docs){
    await deleteDoc(doc(db,"parties",leader,"members",m.id));
  }
  await deleteDoc(doc(db,"parties",leader));
};

</script>


</body>
</html>
