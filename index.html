<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  height:100vh;
  color:white;
}
.main{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.lobby{
  background:white;
  color:black;
  padding:40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}
.btn{
  display:block;
  width:200px;
  margin:15px auto;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}
.solo{background:#4CAF50;color:white;}
.multi{background:#ff9800;color:white;}
.sidebar{
  width:330px;
  background:rgba(0,0,0,0.35);
  padding:20px;
  overflow-y:auto;
}
.friend{
  background:white;
  color:black;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
}
button{
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-top:5px;
}
.add-btn{background:#4CAF50;color:white;}
input{
  width:100%;
  padding:5px;
  margin-top:5px;
}
.status{
  font-size:12px;
  color:gray;
}

.invite-btn{background:#4CAF50;color:white;}
.delete-btn{background:#f44336;color:white;}

.party-box{
  background:#222;
  color:white;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}

.party-member{
  background:#333;
  padding:5px;
  margin-top:5px;
  border-radius:6px;
}

</style>
</head>

<body>

<div class="main">
  <div class="lobby">
    <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</h1>
    <button class="btn solo">ä¸€äººã§ãƒ—ãƒ¬ã‚¤</button>
    <button class="btn multi">ã¿ã‚“ãªã§ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>

<div class="sidebar">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div id="profileArea"></div>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </h2>
  <input id="friendCodeInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰8æ¡">
  <button class="add-btn" onclick="requestFriend()">ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</button>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h2>
  <div id="friendList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, doc, setDoc, getDoc, collection, 
  onSnapshot, deleteDoc, getDocs 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { 
  getDatabase, ref, set, onValue, onDisconnect 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXnNXQ5khcR0EvRide4C0PjshJZpSF4oM",
  authDomain: "typing-game-28ed0.firebaseapp.com",
  projectId: "typing-game-28ed0",
  databaseURL: "https://typing-game-28ed0-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rtdb = getDatabase(app);

/* ===== åˆæœŸ ===== */
function randomNumber(l){
  let r="";for(let i=0;i<l;i++){r+=Math.floor(Math.random()*10);}return r;
}
if(!localStorage.playerName){localStorage.playerName="åœ’å:"+randomNumber(12);}
if(!localStorage.friendCode){localStorage.friendCode=randomNumber(8);}

const myCode=localStorage.friendCode;
const myName=localStorage.playerName;

/* ===== ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç®¡ç†ï¼ˆå®Œå…¨ç‰ˆï¼‰===== */
const statusRef=ref(rtdb,"status/"+myCode);

set(statusRef,{online:true,name:myName});
onDisconnect(statusRef).set({online:false,name:myName});

/* ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ===== */
document.getElementById("profileArea").innerHTML=`
åå‰:<br>
<input id="nameInput" value="${myName}">
<button onclick="changeName()">å¤‰æ›´</button>
<hr>
ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰:<br>
<strong>${myCode}</strong>
`;

window.changeName=function(){
  localStorage.playerName=document.getElementById("nameInput").value;
  location.reload();
};

await setDoc(doc(db,"users",myCode),{name:myName},{merge:true});

/* ===== ãƒ•ãƒ¬ãƒ³ãƒ‰ ===== */
window.requestFriend=async function(){
  const code=document.getElementById("friendCodeInput").value;
  const snap=await getDoc(doc(db,"users",code));
  if(!snap.exists()) return alert("å­˜åœ¨ã—ã¾ã›ã‚“");

  await setDoc(doc(db,"users",myCode,"friends",code),{name:snap.data().name});
  await setDoc(doc(db,"users",code,"friends",myCode),{name:myName});
};

window.removeFriend=async function(code){
  await deleteDoc(doc(db,"users",myCode,"friends",code));
  await deleteDoc(doc(db,"users",code,"friends",myCode));
};

/* ===== ãƒ•ãƒ¬ãƒ³ãƒ‰è¡¨ç¤º + ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å®‰å®šç‰ˆ ===== */
onSnapshot(collection(db,"users",myCode,"friends"),(snap)=>{
  const list=document.getElementById("friendList");
  list.innerHTML="";

  snap.forEach(docSnap=>{
    const code=docSnap.id;

    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${docSnap.data().name}</strong><br>
      Code:${code}<br>
      <span id="status-${code}">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span><br>
      <button class="invite-btn" onclick="inviteParty('${code}')">ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼æ‹›å¾…</button>
      <button class="delete-btn" onclick="removeFriend('${code}')">å‰Šé™¤</button>
    `;
    list.appendChild(div);

    onValue(ref(rtdb,"status/"+code),(s)=>{
      const el=document.getElementById("status-"+code);
      if(s.exists() && s.val().online){
        el.innerHTML="<span style='color:green'>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>";
      }else{
        el.innerHTML="<span style='color:red'>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>";
      }
    });
  });
});

/* ===== æ‹›å¾… ===== */
window.inviteParty = async function(target){
  await setDoc(doc(db,"users",target,"invites",myCode),{
    from:myCode,
    fromName:myName
  });
  alert("æ‹›å¾…é€ä¿¡ï¼");
};

onSnapshot(collection(db,"users",myCode,"invites"),(snapshot)=>{
  snapshot.docChanges().forEach(async change=>{
    if(change.type==="added"){
      const data=change.doc.data();
      if(confirm(data.fromName+" ã‹ã‚‰æ‹›å¾…ï¼å‚åŠ ã™ã‚‹ï¼Ÿ")){
        await joinParty(data.from);
      }
      await deleteDoc(doc(db,"users",myCode,"invites",change.doc.id));
    }
  });
});

/* ===== ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ ===== */
async function joinParty(leader){
  await setDoc(doc(db,"parties",leader),{leader:leader},{merge:true});
  await setDoc(doc(db,"parties",leader,"members",myCode),{name:myName});
}

/* ğŸ”¥ ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼UIå®Œå…¨ç›£è¦– */
onSnapshot(collection(db,"parties"),async(snapshot)=>{
  const list=document.getElementById("friendList");

  snapshot.forEach(async partyDoc=>{
    const leader=partyDoc.id;
    const membersSnap=await getDocs(collection(db,"parties",leader,"members"));

    membersSnap.forEach(m=>{
      if(m.id===myCode){

        const box=document.createElement("div");
        box.className="party-box";
        box.innerHTML="<h3>ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼</h3>";
        box.innerHTML+="äººæ•°:"+membersSnap.size+"<br>";

        membersSnap.forEach(mem=>{
          box.innerHTML+=`
            <div class="party-member">
              ${mem.data().name}
              ${leader===myCode && mem.id!==myCode ?
                `<button onclick="kick('${leader}','${mem.id}')">ã‚­ãƒƒã‚¯</button>`:""}
            </div>
          `;
        });

        if(leader===myCode){
          box.innerHTML+=`<button onclick="disband('${leader}')">è§£æ•£</button>`;
        }else{
          box.innerHTML+=`<button onclick="leave('${leader}')">é›¢è„±</button>`;
        }

        list.appendChild(box);
      }
    });
  });
});

/* ã‚­ãƒƒã‚¯ */
window.kick=async function(leader,member){
  await deleteDoc(doc(db,"parties",leader,"members",member));
};

/* é›¢è„± */
window.leave=async function(leader){
  await deleteDoc(doc(db,"parties",leader,"members",myCode));
};

/* è§£æ•£ */
window.disband=async function(leader){
  const members=await getDocs(collection(db,"parties",leader,"members"));
  members.forEach(async m=>{
    await deleteDoc(doc(db,"parties",leader,"members",m.id));
  });
  await deleteDoc(doc(db,"parties",leader));
};
</script>




</body>
</html>
