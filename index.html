<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Typing - Full Engine</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <audio id="bgm-lobby" src="https://assets.mixkit.co/active_storage/sfx/123/123-preview.mp3" loop></audio>
    <audio id="bgm-battle" src="https://assets.mixkit.co/active_storage/sfx/2068/2068-preview.mp3" loop></audio>
    <audio id="sound-type" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="sound-error" src="https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3"></audio>
    <audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/2014/2014-preview.mp3"></audio>
    <audio id="sound-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sound-start" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>
    <audio id="sound-join" src="https://assets.mixkit.co/active_storage/sfx/2569/2569-preview.mp3"></audio>
    <audio id="sound-sizzle" src="https://assets.mixkit.co/active_storage/sfx/2569/2569-preview.mp3"></audio>

    <div id="invite-notification" class="hidden">
        <div class="notify-content">
            <p><span id="inviter-name">---</span> さんからパーティー招待！</p>
            <div class="invite-btns">
                <button id="accept-invite-btn" class="success-btn">参加</button>
                <button id="decline-invite-btn" class="danger-btn">拒否</button>
            </div>
        </div>
    </div>

    <div id="battle-toast" class="hidden"></div>

    <div id="app-container">
        <main id="game-main">
            <header>
                <h1>TYPING ONLINE</h1>
            </header>
            
            <div id="typing-screen">
                
                <div id="mode-selection" class="menu-screen">
                    <button class="mode-btn" id="single-play-btn">一人でプレイ</button>
                    <button class="mode-btn" id="custom-play-btn">作ったものを遊ぶ</button>
                    <button class="mode-btn" id="friend-play-btn">フレンドと対戦</button>
                    <button class="mode-btn" id="online-play-btn">オンライン対戦</button>
                    <button class="mode-btn" id="open-editor-btn" style="margin-top: 20px; font-size: 1rem; padding: 15px 30px;">タイピングを作る</button>
                    <p id="mode-error-msg" class="error-text hidden"></p>
                </div>

                <div id="online-selection" class="menu-screen hidden">
                    <h2 class="menu-title">オンライン対戦</h2>
                    <p>人数を選んでください</p>
                    <div class="diff-btns">
                        <button class="diff-btn easy" onclick="joinMatchmaking(2)">
                            <span class="diff-name">2人対戦</span>
                        </button>
                        <button class="diff-btn normal" onclick="joinMatchmaking(3)">
                            <span class="diff-name">3人対戦</span>
                        </button>
                        <button class="diff-btn hard" onclick="joinMatchmaking(4)">
                            <span class="diff-name">4人対戦</span>
                        </button>
                    </div>
                    <button class="back-btn" onclick="showScreen('mode')">メインメニューへ</button>
                </div>

                <div id="online-waiting" class="menu-screen hidden">
                    <h2 class="menu-title">マッチング待機中...</h2>
                    <p>他のプレイヤーを待っています</p>
                    <h1 id="online-wait-count" style="color: #00d4ff;">1 / ?</h1>
                    <button class="back-btn" onclick="cancelMatchmaking()">キャンセル</button>
                </div>

                <div id="custom-editor" class="menu-screen hidden">
                    <h2 class="menu-title">タイピングを作る</h2>
                    <p>※ひらがなで入力（2〜15文字） / 現在: <span id="custom-count">0</span>個（最低5、最高20）</p>
                    <div id="custom-word-list" style="max-height: 250px; overflow-y: auto; width: 80%; background: #111; padding: 10px; border-radius: 10px;">
                        </div>
                    <div class="btn-row">
                        <button class="success-btn" onclick="addCustomWord()" style="padding: 10px 20px;">+ 増やす</button>
                        <button class="mode-btn" onclick="saveCustomWords()" style="padding: 10px 20px;">完成！</button>
                        <button class="back-btn" onclick="showScreen('mode')" style="margin-top: 0;">メインメニューへ</button>
                    </div>
                </div>

                <div id="difficulty-selection" class="menu-screen hidden">
                    <h2 class="menu-title">難易度を選択</h2>
                    <div class="diff-btns">
                        <button class="diff-btn easy" data-level="easy">
                            <span class="diff-name">かんたん</span>
                            <small class="best-score">Best: <span id="best-easy">0</span></small>
                        </button>
                        <button class="diff-btn normal" data-level="normal">
                            <span class="diff-name">ちゅうきゅう</span>
                            <small class="best-score">Best: <span id="best-normal">0</span></small>
                        </button>
                        <button class="diff-btn hard" data-level="hard">
                            <span class="diff-name">むずかしい</span>
                            <small class="best-score">Best: <span id="best-hard">0</span></small>
                        </button>
                    </div>
                    <button class="back-btn" id="back-to-mode">メインメニューへ</button>
                </div>

                <div id="battle-setup" class="menu-screen hidden">
                    <h2 class="menu-title">バトル設定 (リーダー)</h2>
                    <div class="setup-group">
                        <label>難易度:</label>
                        <select id="battle-diff-select">
                            <option value="easy">かんたん</option>
                            <option value="normal" selected>ちゅうきゅう</option>
                            <option value="hard">むずかしい</option>
                        </select>
                    </div>
                    <div class="setup-group">
                        <label>制限時間: <span id="time-val">30</span>秒</label>
                        <input type="range" id="battle-time-range" min="10" max="60" step="10" value="30">
                    </div>
                    <div class="btn-row">
                        <button id="start-battle-trigger" class="mode-btn success-btn" style="padding: 15px 30px; font-size: 1.2rem;">スタート！</button>
                        <button class="back-btn" onclick="showScreen('mode')">メインメニューへ</button>
                    </div>
                </div>

                <div id="battle-waiting" class="menu-screen hidden">
                    <h2 class="menu-title">待機中...</h2>
                    <p>リーダーが設定を完了するのを待っています。</p>
                </div>

                <div id="game-play-area" class="menu-screen hidden">
                    <div id="battle-header" class="hidden">
                        <div id="timer-display">TIME: --</div>
                    </div>
                    
                    <div id="rival-lanes" class="hidden"></div>

                    <div id="combo-display">0 COMBO</div>
                    <div id="japanese-word">読み込み中</div>
                    <div id="roma-display">
                        <span id="char-done" class="text-done"></span><span id="char-todo" class="text-todo"></span>
                    </div>
                    
                    <div class="game-info">
                        SCORE: <span id="score-count">0</span>
                    </div>
                    <button class="end-btn" id="end-game-btn">中断してメインメニューへ</button>
                </div>

                <div id="result-screen" class="menu-screen hidden">
                    <h1 class="timeout-text">Timeout!</h1>
                    <div id="ranking-list"></div>
                    <button class="mode-btn" onclick="showScreen('mode')" style="padding: 15px 30px; font-size: 1.2rem; margin-top: 20px;">メインメニューに戻る</button>
                </div>

            </div>
        </main>

        <aside id="right-sidebar">
            <section class="sidebar-section">
                <h2>プロフィール</h2>
                <div class="card">
                    <p>NAME: <strong id="display-name">---</strong></p>
                    <div class="input-group">
                        <input type="text" id="name-input" placeholder="名前変更" maxlength="12">
                        <button id="update-name-btn">更新</button>
                    </div>
                    <div class="code-box">
                        <small>マイコード</small>
                        <code id="my-friend-code">--------</code>
                    </div>
                </div>
            </section>

            <section class="sidebar-section">
                <div class="header-flex">
                    <h2>フレンド</h2>
                    <span id="friend-count-badge" class="badge">0</span>
                </div>
                <div class="input-group">
                    <input type="text" id="target-code-input" placeholder="8桁コードで追加" maxlength="8">
                    <button id="send-request-btn">追加</button>
                </div>
                <ul id="friend-list"></ul>
            </section>

            <section class="sidebar-section">
                <h2>パーティー</h2>
                <div id="party-container" class="card">
                    <div id="no-party-msg">パーティー未参加</div>
                    <div id="party-info" class="hidden">
                        <div id="party-member-list"></div>
                        <div id="party-controls" class="margin-top"></div>
                    </div>
                </div>
            </section>
        </aside>
    </div>

    <script type="importmap">
        {
          "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
          }
        }
    </script>
    <script type="module" src="script.js"></script>
</body>
</html>
