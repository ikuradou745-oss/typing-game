<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  height:100vh;
  color:white;
}
.main{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.lobby{
  background:white;
  color:black;
  padding:40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}
.btn{
  display:block;
  width:200px;
  margin:15px auto;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}
.solo{background:#4CAF50;color:white;}
.multi{background:#ff9800;color:white;}
.sidebar{
  width:330px;
  background:rgba(0,0,0,0.35);
  padding:20px;
  overflow-y:auto;
}
.friend{
  background:white;
  color:black;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
}
button{
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-top:5px;
}
.add-btn{background:#4CAF50;color:white;}
input{
  width:100%;
  padding:5px;
  margin-top:5px;
}
.status{
  font-size:12px;
  color:gray;
}
</style>
</head>

<body>

<div class="main">
  <div class="lobby">
    <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</h1>
    <button class="btn solo">ä¸€äººã§ãƒ—ãƒ¬ã‚¤</button>
    <button class="btn multi">ã¿ã‚“ãªã§ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>

<div class="sidebar">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div id="profileArea"></div>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </h2>
  <input id="friendCodeInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰8æ¡">
  <button class="add-btn" onclick="requestFriend()">ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</button>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h2>
  <div id="friendList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getDatabase, ref, set, onValue, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXnNXQ5khcR0EvRide4C0PjshJZpSF4oM",
  authDomain: "typing-game-28ed0.firebaseapp.com",
  projectId: "typing-game-28ed0",
  databaseURL: "https://typing-game-28ed0-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rtdb = getDatabase(app);

/* åˆæœŸè¨­å®š */
function randomNumber(length){
  let r="";
  for(let i=0;i<length;i++){
    r+=Math.floor(Math.random()*10);
  }
  return r;
}

if(!localStorage.playerName){
  localStorage.playerName="åœ’å:"+randomNumber(12);
}
if(!localStorage.friendCode){
  localStorage.friendCode=randomNumber(8);
}

const myCode = localStorage.friendCode;
const myName = localStorage.playerName;

/* ğŸ”¥ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç®¡ç†ï¼ˆå¸¸æ™‚ç›£è¦–ï¼‰ */
const statusRef = ref(rtdb, "status/" + myCode);
set(statusRef, { online:true, name:myName });
onDisconnect(statusRef).set({ online:false, name:myName });

/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« */
function renderProfile(){
  document.getElementById("profileArea").innerHTML=`
    åå‰:<br>
    <input id="nameInput" value="${localStorage.playerName}">
    <button onclick="changeName()">å¤‰æ›´</button>
    <hr>
    ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰:<br>
    <strong>${localStorage.friendCode}</strong>
  `;
}
window.changeName = function(){
  localStorage.playerName=document.getElementById("nameInput").value;
  location.reload();
};

/* ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ  */
window.requestFriend = async function(){
  const code=document.getElementById("friendCodeInput").value;
  if(code.length!==8) return alert("8æ¡å…¥åŠ›ï¼");

  const targetSnap = await getDoc(doc(db,"users",code));
  if(!targetSnap.exists()) return alert("å­˜åœ¨ã—ã¾ã›ã‚“");

  await setDoc(doc(db,"users",myCode,"friends",code),{name:targetSnap.data().name});
  await setDoc(doc(db,"users",code,"friends",myCode),{name:myName});
};

/* ãƒ•ãƒ¬ãƒ³ãƒ‰å‰Šé™¤ */
window.removeFriend = async function(code){
  await deleteDoc(doc(db,"users",myCode,"friends",code));
  await deleteDoc(doc(db,"users",code,"friends",myCode));
};

/* ãƒ•ãƒ¬ãƒ³ãƒ‰è¡¨ç¤º */
onSnapshot(collection(db,"users",myCode,"friends"),(snapshot)=>{
  const list=document.getElementById("friendList");
  list.innerHTML="";

  snapshot.forEach(docSnap=>{
    const friendCode=docSnap.id;
    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${docSnap.data().name}</strong><br>
      Code:${friendCode}<br>
      <span id="status-${friendCode}">ç¢ºèªä¸­...</span><br>
      <button onclick="inviteParty('${friendCode}')">ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼æ‹›å¾…</button>
      <button onclick="removeFriend('${friendCode}')">å‰Šé™¤</button>
    `;
    list.appendChild(div);

    /* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç›£è¦– */
    onValue(ref(rtdb,"status/"+friendCode),(snap)=>{
      const el=document.getElementById("status-"+friendCode);
      if(!snap.exists() || !snap.val().online){
        el.innerHTML="<span style='color:red'>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>";
      }else{
        el.innerHTML="<span style='color:green'>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>";
      }
    });
  });
});

/* ===== ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼æ©Ÿèƒ½ ===== */

window.inviteParty = async function(targetCode){
  await setDoc(doc(db,"partyInvites",targetCode),{
    from:myCode,
    fromName:myName
  });
};

/* æ‹›å¾…å—ä¿¡ */
onSnapshot(doc(db,"partyInvites",myCode),(snap)=>{
  if(!snap.exists()) return;
  const data=snap.data();
  alert(data.fromName+" ã‹ã‚‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼æ‹›å¾…ãŒå±Šã„ã¦ã„ã¾ã™ï¼");
  if(confirm("å‚åŠ ã—ã¾ã™ã‹ï¼Ÿ")){
    joinParty(data.from);
  }
});

/* ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼å‚åŠ  */
async function joinParty(leaderCode){
  await setDoc(doc(db,"parties",leaderCode,"members",myCode),{
    name:myName
  });
  await setDoc(doc(db,"parties",leaderCode),{
    leader:leaderCode
  },{merge:true});
}

/* ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ç›£è¦– */
onSnapshot(collection(db,"parties",myCode,"members"),(snap)=>{
  if(snap.empty) return;

  let html="<hr><h3>ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼</h3>";
  html+="äººæ•°:"+snap.size+"<br>";

  snap.forEach(m=>{
    html+=m.data().name+"<br>";
  });

  document.getElementById("friendList").innerHTML+=html;
});

renderProfile();
</script>



</body>
</html>
