<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  height:100vh;
  color:white;
}
.main{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.lobby{
  background:white;
  color:black;
  padding:40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}
.btn{
  display:block;
  width:200px;
  margin:15px auto;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}
.solo{background:#4CAF50;color:white;}
.multi{background:#ff9800;color:white;}
.sidebar{
  width:330px;
  background:rgba(0,0,0,0.35);
  padding:20px;
  overflow-y:auto;
}
.friend{
  background:white;
  color:black;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
}
button{
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-top:5px;
}
.add-btn{background:#4CAF50;color:white;}
input{
  width:100%;
  padding:5px;
  margin-top:5px;
}
.status{
  font-size:12px;
  color:gray;
}
</style>
</head>

<body>

<div class="main">
  <div class="lobby">
    <h1>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆå¯¾æˆ¦ã‚ã‚Šï¼‰</h1>
    <button class="btn solo">ä¸€äººã§ãƒ—ãƒ¬ã‚¤</button>
    <button class="btn multi">ã¿ã‚“ãªã§ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>

<div class="sidebar">
  <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
  <div id="profileArea"></div>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </h2>
  <input id="friendCodeInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰8æ¡">
  <button class="add-btn" onclick="requestFriend()">ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</button>

  <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h2>
  <div id="friendList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXnNXQ5khcR0EvRide4C0PjshJZpSF4oM",
  authDomain: "typing-game-28ed0.firebaseapp.com",
  projectId: "typing-game-28ed0",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function randomNumber(length){
  let r="";
  for(let i=0;i<length;i++){
    r+=Math.floor(Math.random()*10);
  }
  return r;
}

if(!localStorage.playerName){
  localStorage.playerName="åœ’å:"+randomNumber(12);
}
if(!localStorage.friendCode){
  localStorage.friendCode=randomNumber(8);
}

const myCode = localStorage.friendCode;
const myName = localStorage.playerName;

function renderProfile(){
  document.getElementById("profileArea").innerHTML=`
    åå‰:<br>
    <input id="nameInput" value="${localStorage.playerName}">
    <button onclick="changeName()">å¤‰æ›´</button>
    <hr>
    ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰:<br>
    <strong>${localStorage.friendCode}</strong>
  `;
}
window.changeName = function(){
  const newName=document.getElementById("nameInput").value;
  localStorage.playerName=newName;
  location.reload();
};

/* ğŸ”¥ è‡ªåˆ†ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ã™ã‚‹ */
await setDoc(doc(db,"users",myCode),{
  name: myName,
  online: true
},{merge:true});

/* ãƒšãƒ¼ã‚¸é–‰ã˜ãŸã‚‰ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ */
window.addEventListener("beforeunload", async ()=>{
  await updateDoc(doc(db,"users",myCode),{
    online: false
  });
});

/* ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ ï¼ˆä¸¡æ–¹å‘ï¼‰ */
window.requestFriend = async function(){
  const code=document.getElementById("friendCodeInput").value;
  if(code.length!==8) return alert("8æ¡å…¥åŠ›ï¼");

  const targetRef = doc(db,"users",code);
  const targetSnap = await getDoc(targetRef);

  if(!targetSnap.exists()){
    return alert("ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“");
  }

  await setDoc(doc(db,"users",myCode,"friends",code),{
    name: targetSnap.data().name
  });

  await setDoc(doc(db,"users",code,"friends",myCode),{
    name: myName
  });
};

/* ğŸ”¥ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º */
onSnapshot(collection(db,"users",myCode,"friends"), async (snapshot)=>{
  const list=document.getElementById("friendList");
  list.innerHTML="";

  for(const docSnap of snapshot.docs){
    const friendCode = docSnap.id;
    const friendRef = doc(db,"users",friendCode);
    const friendSnap = await getDoc(friendRef);

    let statusText="ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
    let statusColor="red";

    if(friendSnap.exists() && friendSnap.data().online){
      statusText="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³";
      statusColor="green";
    }

    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${docSnap.data().name}</strong><br>
      Code:${friendCode}<br>
      <span class="status" style="color:${statusColor}">
        ${statusText}
      </span>
    `;
    list.appendChild(div);
  }
});

renderProfile();
</script>


</body>
</html>
