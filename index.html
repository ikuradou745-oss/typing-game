<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>タイピング（対戦あり）</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  display:flex;
  height:100vh;
  color:white;
}
.main{
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
}
.lobby{
  background:white;
  color:black;
  padding:40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,0.3);
}
.btn{
  display:block;
  width:200px;
  margin:15px auto;
  padding:12px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-size:16px;
}
.solo{background:#4CAF50;color:white;}
.multi{background:#ff9800;color:white;}
.sidebar{
  width:330px;
  background:rgba(0,0,0,0.35);
  padding:20px;
  overflow-y:auto;
}
.friend{
  background:white;
  color:black;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
}
button{
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  margin-top:5px;
}
.add-btn{background:#4CAF50;color:white;}
input{
  width:100%;
  padding:5px;
  margin-top:5px;
}
.status{
  font-size:12px;
  color:gray;
}

.invite-btn{background:#4CAF50;color:white;}
.delete-btn{background:#f44336;color:white;}

.party-box{
  background:#222;
  color:white;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
}

.party-member{
  background:#333;
  padding:5px;
  margin-top:5px;
  border-radius:6px;
}

</style>
</head>

<body>

<div class="main">
  <div class="lobby">
    <h1>タイピング（対戦あり）</h1>
    <button class="btn solo">一人でプレイ</button>
    <button class="btn multi">みんなでプレイ</button>
  </div>
</div>

<div class="sidebar">
  <h2>プロフィール</h2>
  <div id="profileArea"></div>
  <div id="partyArea"></div>

  <h2>フレンド追加</h2>
  <input id="friendCodeInput" placeholder="フレンドコード8桁">
  <button class="add-btn" onclick="requestFriend()">フレンド申請</button>

  <h2>フレンドリスト</h2>
  <div id="friendList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, collection,
  onSnapshot, deleteDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getDatabase, ref, set, onValue, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBXnNXQ5khcR0EvRide4C0PjshJZpSF4oM",
  authDomain: "typing-game-28ed0.firebaseapp.com",
  projectId: "typing-game-28ed0",
  databaseURL: "https://typing-game-28ed0-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const rtdb = getDatabase(app);

/* ===== 初期 ===== */
function rand(l){let r="";for(let i=0;i<l;i++){r+=Math.floor(Math.random()*10);}return r;}
if(!localStorage.playerName) localStorage.playerName="園名:"+rand(6);
if(!localStorage.friendCode) localStorage.friendCode=rand(8);

const myCode=localStorage.friendCode;
let myName=localStorage.playerName;

/* ===== オンライン（超安定版） ===== */
const statusRef=ref(rtdb,"status/"+myCode);

function updateOnline(state){
  set(statusRef,{
    online:state,
    name:myName,
    lastSeen:Date.now()
  });
}

updateOnline(true);
onDisconnect(statusRef).set({
  online:false,
  name:myName,
  lastSeen:Date.now()
});

/* 5秒ごと更新 */
setInterval(()=>updateOnline(true),5000);

/* ===== プロフィール ===== */
document.getElementById("profileArea").innerHTML=`
名前:<br>
<input id="nameInput" value="${myName}">
<button id="nameBtn">変更</button>
<hr>
フレンドコード:<br>
<strong>${myCode}</strong>
`;

document.getElementById("nameBtn").onclick=()=>{
  myName=document.getElementById("nameInput").value;
  localStorage.playerName=myName;
  updateOnline(true);
  setDoc(doc(db,"users",myCode),{name:myName},{merge:true});
};

await setDoc(doc(db,"users",myCode),{name:myName},{merge:true});

/* ===== フレンド ===== */
window.requestFriend=async function(){
  const code=document.getElementById("friendCodeInput").value.trim();
  const snap=await getDoc(doc(db,"users",code));
  if(!snap.exists()) return alert("存在しません");
  await setDoc(doc(db,"users",myCode,"friends",code),{name:snap.data().name});
  await setDoc(doc(db,"users",code,"friends",myCode),{name:myName});
};

window.removeFriend=async function(code){
  await deleteDoc(doc(db,"users",myCode,"friends",code));
  await deleteDoc(doc(db,"users",code,"friends",myCode));
};

/* ===== フレンド表示 ===== */
onSnapshot(collection(db,"users",myCode,"friends"),(snap)=>{
  const list=document.getElementById("friendList");
  list.innerHTML="";

  snap.forEach(docSnap=>{
    const code=docSnap.id;

    const div=document.createElement("div");
    div.className="friend";
    div.innerHTML=`
      <strong>${docSnap.data().name}</strong><br>
      Code:${code}<br>
      <span id="status-${code}">確認中...</span><br>
      <button style="background:#4CAF50;color:white;" onclick="inviteParty('${code}')">招待</button>
      <button style="background:#f44336;color:white;" onclick="removeFriend('${code}')">削除</button>
    `;
    list.appendChild(div);

    onValue(ref(rtdb,"status/"+code),(s)=>{
      const el=document.getElementById("status-"+code);
      if(!el) return;

      if(s.exists()){
        const data=s.val();
        const diff=Date.now()-(data.lastSeen||0);
        if(data.online && diff<15000){
          el.innerHTML="<span style='color:green'>オンライン</span>";
        }else{
          el.innerHTML="<span style='color:red'>オフライン</span>";
        }
      }else{
        el.innerHTML="<span style='color:red'>オフライン</span>";
      }
    });
  });
});

/* ===== 招待（左上・大きめUI） ===== */
window.inviteParty=async function(target){
  await setDoc(doc(db,"users",target,"invites",myCode),{
    from:myCode,
    fromName:myName
  });
};

/* 招待受信 */
onSnapshot(collection(db,"users",myCode,"invites"),(snapshot)=>{
  snapshot.docChanges().forEach(change=>{
    if(change.type==="added"){
      const data=change.doc.data();
      showInviteUI(change.doc.id,data.from,data.fromName);
    }
  });
});

function showInviteUI(id,leader,name){

  const box=document.createElement("div");
  box.id="invite-"+id;
  box.style.position="fixed";
  box.style.top="20px";
  box.style.left="20px";
  box.style.background="white";
  box.style.color="black";
  box.style.padding="20px";
  box.style.borderRadius="15px";
  box.style.boxShadow="0 10px 25px rgba(0,0,0,0.4)";
  box.style.fontSize="18px";
  box.style.zIndex="9999";

  box.innerHTML=`
    <div style="margin-bottom:10px;">
      <strong>${name}</strong> からパーティー招待！
    </div>
    <button id="ok-${id}" style="background:#4CAF50;color:white;padding:10px 15px;border:none;border-radius:8px;margin-right:10px;">参加</button>
    <button id="ng-${id}" style="background:#f44336;color:white;padding:10px 15px;border:none;border-radius:8px;">拒否</button>
  `;

  document.body.appendChild(box);

  document.getElementById("ok-"+id).onclick=async()=>{
    await joinParty(leader);
    await deleteDoc(doc(db,"users",myCode,"invites",id));
    box.remove();
  };

  document.getElementById("ng-"+id).onclick=async()=>{
    await deleteDoc(doc(db,"users",myCode,"invites",id));
    box.remove();
  };
}

/* ===== パーティー参加 ===== */
async function joinParty(leader){
  await setDoc(doc(db,"parties",leader),{leader:leader},{merge:true});
  await setDoc(doc(db,"parties",leader,"members",leader),{name:"リーダー"},{merge:true});
  await setDoc(doc(db,"parties",leader,"members",myCode),{name:myName});
}

/* ===== パーティーUI ===== */
onSnapshot(collection(db,"parties"),async(snapshot)=>{
  const area=document.getElementById("partyArea");
  if(!area) return;
  area.innerHTML="";

  for(const party of snapshot.docs){
    const leader=party.id;
    const members=await getDocs(collection(db,"parties",leader,"members"));

    const isMember=members.docs.some(m=>m.id===myCode);
    if(!isMember) continue;

    const box=document.createElement("div");
    box.className="party-box";
    box.innerHTML="<h3>パーティー</h3>";
    box.innerHTML+="人数:"+members.size+"<br>";

    members.forEach(m=>{
      box.innerHTML+=`
        <div class="party-member">
          ${m.data().name}
        </div>
      `;
    });

    if(leader===myCode){
      box.innerHTML+=`<button style="background:#f44336;color:white;" onclick="disband('${leader}')">解散</button>`;
    }else{
      box.innerHTML+=`<button style="background:#ff9800;color:white;" onclick="leave('${leader}')">離脱</button>`;
    }

    area.appendChild(box);
  }
});

window.leave=async function(leader){
  await deleteDoc(doc(db,"parties",leader,"members",myCode));
};

window.disband=async function(leader){
  const members=await getDocs(collection(db,"parties",leader,"members"));
  for(const m of members.docs){
    await deleteDoc(doc(db,"parties",leader,"members",m.id));
  }
  await deleteDoc(doc(db,"parties",leader));
};
</script>


</body>
</html>
